FROM nginx:stable-alpine AS version_extractor
RUN nginx -v 2>&1 | awk -F/ '{print $2}' > /nginx_version

FROM nginx:stable-alpine AS builder
COPY --from=version_extractor /nginx_version /nginx_version
ARG NGINX_VERSION
RUN export NGINX_VERSION=$(cat /nginx_version) && echo $NGINX_VERSION
RUN apk add --no-cache \
    build-base \
    pcre-dev \
    zlib-dev \
    openssl-dev \
    linux-headers \
    curl \
    git
RUN mkdir -p /usr/src \
    && cd /usr/src \
    && curl -LO http://nginx.org/download/nginx-${NGINX_VERSION}.tar.gz \
    && tar -zxvf nginx-${NGINX_VERSION}.tar.gz
RUN git clone https://github.com/nginx-modules/ngx_cache_purge /usr/src/ngx_cache_purge
RUN cd /usr/src/nginx-${NGINX_VERSION} \
    && ./configure --with-compat --add-dynamic-module=/usr/src/ngx_cache_purge \
    && make modules

FROM nginx:stable-alpine
COPY --from=builder /usr/src/nginx-${NGINX_VERSION}/objs/ngx_http_cache_purge_module.so /etc/nginx/modules/